name: CI

on:
  pull_request:
    branches: ["*"]
  push:
    branches: ["*"]
    tags:
      - "v*"

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      core: ${{ steps.filter.outputs.core }}
      react: ${{ steps.filter.outputs.react }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            core:
              - 'packages/core/**'
            react:
              - 'packages/react/**'

  core-ci:
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.core == 'true' }}
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "10"
          run_install: false

      - name: Install
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Test
        run: pnpm run test:coverage core

      - name: Build
        run: pnpm run build:core

  react-ci:
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.react == 'true' }}
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "10"
          run_install: false

      - name: Install
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Test
        run: pnpm run test:coverage react

      - name: Build
        run: pnpm run build:react

  release:
    runs-on: ubuntu-latest
    needs: [core-ci, react-ci]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify tag is on release
        run: |
          COMMIT=$(git rev-list -n 1 ${{ github.ref }})
          if ! git merge-base --is-ancestor $COMMIT release; then
            echo "❌ Tag is not on release branch. Release cancelled."
            exit 1
          fi
          echo "✓ Tag is on release. Proceeding with release."

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          registry-url: "https://registry.npmjs.org"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "10"
          run_install: false

      - name: Install
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Resolve npm dist-tag
        run: |
          if [[ "${GITHUB_REF_NAME}" == *"-alpha."* ]]; then
            echo "NPM_DIST_TAG=alpha" >> $GITHUB_ENV
          else
            echo "NPM_DIST_TAG=latest" >> $GITHUB_ENV
          fi

      - name: Publish core
        run: pnpm -C packages/core publish --access public --tag ${{ env.NPM_DIST_TAG }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish react
        run: pnpm -C packages/react publish --access public --tag ${{ env.NPM_DIST_TAG }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  sync-main-to-release:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create or update sync PR
        run: |
          prNumber=$(gh pr list --base release --head main --state open -L 1 --json number -q '.[0].number')
          if [ -z "$prNumber" ]; then
            gh pr create \
              --base release \
              --head main \
              --title "chore: sync main to release" \
              --body "Automatic sync from main branch"
            prNumber=$(gh pr list --base release --head main --state open -L 1 --json number -q '.[0].number')
          fi
          gh pr merge "$prNumber" --auto --merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/prod'
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "10"
          run_install: false

      - name: Install
        run: pnpm install --frozen-lockfile

      - name: Build demo & storybook
        run: |
          pnpm -C apps/demo-react build
          pnpm -C packages/react build-storybook

      - name: Deploy to Vercel
        run: |
          echo "Deploying to Vercel..."

